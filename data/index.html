<!DOCTYPE html>
<html>
<head>
    <title>Water Gate Controller</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 0; 
            padding: 10px; 
            background: #f5f5f5;
            font-size: 14px;
        }
        .container { max-width: 100%; margin: 0 auto; }
        .card { 
            background: white; 
            border-radius: 8px; 
            padding: 15px; 
            margin: 10px 0; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-header { 
            background: linear-gradient(135deg, #00b4d8 0%, #0077b6 100%); 
            color: white; 
            text-align: center;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .status-header h1 {
            margin: 0 0 15px 0;
            font-size: 24px;
        }
        
        .water-levels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }
        .level-box {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .level-box h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            opacity: 0.9;
        }
        .level-display { 
            font-size: 32px; 
            font-weight: bold; 
        }
        .level-subtitle {
            font-size: 12px;
            margin-top: 5px;
            opacity: 0.8;
        }
        
        .status-indicators {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
        }
        .indicator { 
            padding: 8px 16px; 
            border-radius: 20px; 
            font-weight: bold; 
            font-size: 12px;
            background: rgba(255,255,255,0.2);
        }
        .indicator.auto-on { 
            background: #4caf50; 
            animation: pulse 2s infinite;
        }
        .indicator.in-range { background: #2196f3; }
        .indicator.should-open { background: #ff9800; }
        .indicator.should-close { background: #f44336; }
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.7; } 
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .info-item {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 5px;
            text-align: center;
        }
        .info-item label {
            display: block;
            font-size: 11px;
            color: #666;
            margin-bottom: 5px;
        }
        .info-item value {
            display: block;
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }
        
        .gate-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .gate-card {
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
        }
        .gate-card.enabled {
            border-color: #2196f3;
            background: #e3f2fd;
        }
        .gate-card.open {
            border-color: #4caf50;
            background: #e8f5e9;
        }
        .gate-card.closed {
            border-color: #f44336;
            background: #ffebee;
        }
        .gate-card.moving {
            border-color: #ff9800;
            background: #fff3e0;
            animation: pulse 1s infinite;
        }
        .gate-card h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #333;
        }
        .gate-status {
            font-size: 20px;
            font-weight: bold;
            margin: 10px 0;
            padding: 8px;
            border-radius: 5px;
        }
        .gate-status.open { 
            background: #4caf50; 
            color: white; 
        }
        .gate-status.closed { 
            background: #f44336; 
            color: white; 
        }
        .gate-status.moving { 
            background: #ff9800; 
            color: white; 
        }
        .gate-controls {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        .gate-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        .gate-btn.open { 
            background: #4caf50; 
            color: white; 
        }
        .gate-btn.close { 
            background: #f44336; 
            color: white; 
        }
        .gate-btn.stop { 
            background: #ff9800; 
            color: white; 
        }
        .gate-btn:hover { 
            opacity: 0.8; 
            transform: translateY(-2px);
        }
        .gate-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin: 5px 0;
        }
        .gate-badge.enabled { 
            background: #4caf50; 
            color: white; 
        }
        .gate-badge.disabled { 
            background: #9e9e9e; 
            color: white; 
        }
        
        .card h2 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
            border-bottom: 2px solid #00b4d8;
            padding-bottom: 8px;
        }
        
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
            font-size: 13px;
        }
        .form-group input, 
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        .form-group input:focus, 
        .form-group select:focus {
            outline: none;
            border-color: #00b4d8;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin: 5px;
        }
        .btn-primary {
            background: #00b4d8;
            color: white;
        }
        .btn-primary:hover {
            background: #0077b6;
            transform: translateY(-2px);
        }
        .btn-danger {
            background: #f44336;
            color: white;
        }
        .btn-danger:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }
        
        .toggle-switch {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 30px;
            background: rgba(255,255,255,0.2);
            transition: all 0.3s;
        }
        .toggle-switch:hover {
            background: rgba(255,255,255,0.3);
        }
        .toggle-switch.active {
            background: #4caf50;
        }
        .toggle-slider {
            width: 50px;
            height: 26px;
            background: #ccc;
            border-radius: 13px;
            position: relative;
            transition: background 0.3s;
        }
        .toggle-switch.active .toggle-slider {
            background: #fff;
        }
        .toggle-slider::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }
        .toggle-switch.active .toggle-slider::after {
            transform: translateX(24px);
            background: #4caf50;
        }
        
        .gate-config {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 5px;
            margin: 10px 0;
        }
        .gate-config label {
            font-weight: bold;
            min-width: 70px;
        }
        .gate-config input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .gate-config input[type="text"] {
            flex: 1;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
        }
        
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: bold;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab-btn.active {
            color: #00b4d8;
            border-bottom-color: #00b4d8;
        }
        .tab-btn:hover {
            color: #00b4d8;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="status-header">
            <h1 id="systemTitle">Water Gate Controller</h1>
            
            <div class="water-levels">
                <div class="level-box">
                    <h3>Main Water Level</h3>
                    <div class="level-display" id="mainLevel">-- cm</div>
                    <div class="level-subtitle">Raw: <span id="mainRaw">--</span> cm</div>
                </div>
                <div class="level-box">
                    <h3>Secondary Water Level</h3>
                    <div class="level-display" id="secondaryLevel">-- cm</div>
                    <div class="level-subtitle">Raw: <span id="secondaryRaw">--</span> cm</div>
                </div>
            </div>
            
            <div class="status-indicators">
                <div class="toggle-switch" id="autoToggle" onclick="toggleAutoMode()">
                    <div class="toggle-slider"></div>
                    <span id="autoStatus">OFF</span>
                </div>
                <span class="indicator" id="autoIndicator">AUTO MODE</span>
                <span class="indicator" id="rangeIndicator" style="display: none;">In Target Range</span>
                <span class="indicator" id="actionIndicator" style="display: none;">Should Open</span>
            </div>
        </div>

        <div class="card">
            <h2>System Information</h2>
            <div class="info-grid">
                <div class="info-item">
                    <label>Lower Target</label>
                    <value id="lowerTarget">-60.0 cm</value>
                </div>
                <div class="info-item">
                    <label>Upper Target</label>
                    <value id="upperTarget">-40.0 cm</value>
                </div>
                <div class="info-item">
                    <label>Secondary Min</label>
                    <value id="secondaryMin">-80.0 cm</value>
                </div>
                <div class="info-item">
                    <label>Operation Delay</label>
                    <value id="operationDelay">60 s</value>
                </div>
                <div class="info-item">
                    <label>Uptime</label>
                    <value id="uptime">0d 0h 0m 0s</value>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Gate Status</h2>
            <div class="gate-grid" id="gateGrid">
                <div class="gate-card">
                    <h3>Loading...</h3>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('status')">Status</button>
                <button class="tab-btn" onclick="switchTab('settings')">Settings</button>
                <button class="tab-btn" onclick="switchTab('gates')">Gate Config</button>
            </div>

            <div id="statusTab" class="tab-content active">
                <p>Real-time monitoring of water levels and gate status.</p>
                <button class="btn btn-danger" id="restartBtn">Restart System</button>
            </div>

            <div id="settingsTab" class="tab-content">
                <h2>System Settings</h2>
                <form id="settingsForm">
                    <div class="form-group">
                        <label>Station Name</label>
                        <input type="text" id="stationName" name="stationName" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Measurement Interval (ms)</label>
                        <input type="number" id="interval" name="interval" min="5000" required>
                    </div>
                    
                    <h3 style="margin-top: 30px; color: #00b4d8;">Main Sensor</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Calibration Offset (cm)</label>
                            <input type="number" step="0.1" id="mainCalibrationOffset" name="mainCalibrationOffset" required>
                        </div>
                        <div class="form-group">
                            <label>Sensor to Bottom Distance (cm)</label>
                            <input type="number" step="0.1" id="mainSensorToBottomDistance" name="mainSensorToBottomDistance" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Upper Target (cm)</label>
                            <input type="number" step="0.1" id="mainUpperTarget" name="mainUpperTarget" required>
                        </div>
                        <div class="form-group">
                            <label>Lower Target (cm)</label>
                            <input type="number" step="0.1" id="mainLowerTarget" name="mainLowerTarget" required>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 30px; color: #00b4d8;">Secondary Sensor</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Calibration Offset (cm)</label>
                            <input type="number" step="0.1" id="secondaryCalibrationOffset" name="secondaryCalibrationOffset" required>
                        </div>
                        <div class="form-group">
                            <label>Sensor to Bottom Distance (cm)</label>
                            <input type="number" step="0.1" id="secondarySensorToBottomDistance" name="secondarySensorToBottomDistance" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Minimum Water Level (cm)</label>
                        <input type="number" step="0.1" id="secondaryMinLevel" name="secondaryMinLevel" required>
                    </div>
                    
                    <h3 style="margin-top: 30px; color: #00b4d8;">Gate Operation</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Operation Delay (seconds)</label>
                            <input type="number" id="gateOperationDelay" name="gateOperationDelay" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Auto Mode on Startup</label>
                            <select id="autoModeEnabled" name="autoModeEnabled">
                                <option value="0">Disabled</option>
                                <option value="1">Enabled</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Save Settings</button>
                </form>
            </div>

            <div id="gatesTab" class="tab-content">
                <h2>Gate Configuration</h2>
                <form id="gateConfigForm">
                    <div id="gateConfigs">
                        <!-- Gate configs will be loaded here -->
                    </div>
                    <button type="submit" class="btn btn-primary">Save Gate Config</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        let autoModeState = false;

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }

        function updateStatus() {
            fetch('/current')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('mainLevel').textContent = data.mainWaterLevel.toFixed(1) + ' cm';
                    document.getElementById('mainRaw').textContent = data.mainRawDistance.toFixed(1);
                    document.getElementById('secondaryLevel').textContent = data.secondaryWaterLevel.toFixed(1) + ' cm';
                    document.getElementById('secondaryRaw').textContent = data.secondaryRawDistance.toFixed(1);
                    
                    autoModeState = data.autoMode;
                    const autoIndicator = document.getElementById('autoIndicator');
                    const autoToggle = document.getElementById('autoToggle');
                    const autoStatus = document.getElementById('autoStatus');
                    
                    if (data.autoMode) {
                        autoIndicator.className = 'indicator auto-on';
                        autoToggle.className = 'toggle-switch active';
                        autoStatus.textContent = 'ON';
                    } else {
                        autoIndicator.className = 'indicator';
                        autoToggle.className = 'toggle-switch';
                        autoStatus.textContent = 'OFF';
                    }
                    
                    // Update status indicators
                    const rangeIndicator = document.getElementById('rangeIndicator');
                    const actionIndicator = document.getElementById('actionIndicator');
                    
                    if (data.mainInTargetRange) {
                        rangeIndicator.style.display = 'inline-block';
                        rangeIndicator.textContent = 'In Target Range';
                        rangeIndicator.className = 'indicator in-range';
                    } else {
                        rangeIndicator.style.display = 'none';
                    }
                    
                    if (data.shouldOpen) {
                        actionIndicator.style.display = 'inline-block';
                        actionIndicator.textContent = 'Should Open';
                        actionIndicator.className = 'indicator should-open';
                    } else if (data.shouldClose) {
                        actionIndicator.style.display = 'inline-block';
                        actionIndicator.textContent = 'Should Close';
                        actionIndicator.className = 'indicator should-close';
                    } else {
                        actionIndicator.style.display = 'none';
                    }
                    
                    // Update gate grid
                    const gateGrid = document.getElementById('gateGrid');
                    gateGrid.innerHTML = '';
                    
                    data.gates.forEach(gate => {
                        const gateCard = document.createElement('div');
                        let cardClass = 'gate-card';
                        if (gate.enabled) cardClass += ' enabled';
                        if (gate.isMoving) cardClass += ' moving';
                        else if (gate.isOpen) cardClass += ' open';
                        else cardClass += ' closed';
                        
                        let statusClass = 'gate-status ';
                        let statusText = '';
                        if (gate.isMoving) {
                            statusClass += 'moving';
                            statusText = 'MOVING';
                        } else if (gate.isOpen) {
                            statusClass += 'open';
                            statusText = 'OPEN';
                        } else {
                            statusClass += 'closed';
                            statusText = 'CLOSED';
                        }
                        
                        const badgeClass = gate.enabled ? 'gate-badge enabled' : 'gate-badge disabled';
                        const badgeText = gate.enabled ? 'AUTO ENABLED' : 'MANUAL ONLY';
                        
                        gateCard.className = cardClass;
                        gateCard.innerHTML = `
                            <h3>${gate.name}</h3>
                            <span class="${badgeClass}">${badgeText}</span>
                            <div class="${statusClass}">${statusText}</div>
                            <div class="gate-controls">
                                <button class="gate-btn open" onclick="controlGate(${gate.index}, 'open')">OPEN</button>
                                <button class="gate-btn stop" onclick="controlGate(${gate.index}, 'stop')">STOP</button>
                                <button class="gate-btn close" onclick="controlGate(${gate.index}, 'close')">CLOSE</button>
                            </div>
                        `;
                        gateGrid.appendChild(gateCard);
                    });
                })
                .catch(error => console.error('Error:', error));
                
            fetch('/uptime')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('uptime').textContent = data;
                })
                .catch(error => console.error('Error:', error));
        }

        function loadConfig() {
            fetch('/settings')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('stationName').value = data.stationName;
                    document.getElementById('interval').value = data.measurementInterval;
                    document.getElementById('mainCalibrationOffset').value = data.mainCalibrationOffset;
                    document.getElementById('mainSensorToBottomDistance').value = data.mainSensorToBottomDistance;
                    document.getElementById('mainUpperTarget').value = data.mainUpperTarget;
                    document.getElementById('mainLowerTarget').value = data.mainLowerTarget;
                    document.getElementById('secondaryCalibrationOffset').value = data.secondaryCalibrationOffset;
                    document.getElementById('secondarySensorToBottomDistance').value = data.secondarySensorToBottomDistance;
                    document.getElementById('secondaryMinLevel').value = data.secondaryMinLevel;
                    document.getElementById('gateOperationDelay').value = data.gateOperationDelay;
                    document.getElementById('autoModeEnabled').value = data.autoModeEnabled ? "1" : "0";
                    
                    // Update info display
                    document.getElementById('lowerTarget').textContent = data.mainLowerTarget.toFixed(1);
                    document.getElementById('upperTarget').textContent = data.mainUpperTarget.toFixed(1);
                    document.getElementById('secondaryMin').textContent = data.secondaryMinLevel.toFixed(1);
                    document.getElementById('operationDelay').textContent = data.gateOperationDelay;
                    
                    // Load gate configs
                    const gateConfigs = document.getElementById('gateConfigs');
                    gateConfigs.innerHTML = '';
                    
                    data.gates.forEach(gate => {
                        const div = document.createElement('div');
                        div.className = 'gate-config';
                        div.innerHTML = `
                            <label>Gate ${gate.index + 1}:</label>
                            <input type="checkbox" name="gate${gate.index}_enabled" value="1" ${gate.enabled ? 'checked' : ''}>
                            <input type="text" name="gate${gate.index}_name" value="${gate.name}" placeholder="Gate Name">
                        `;
                        gateConfigs.appendChild(div);
                    });
                })
                .catch(error => console.error('Error:', error));
        }

        function controlGate(gateIndex, action) {
            const formData = new FormData();
            formData.append('gate', gateIndex);
            formData.append('action', action);
            
            fetch('/gateControl', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(data => {
                console.log('Gate control:', data);
                updateStatus();
            })
            .catch(error => console.error('Error:', error));
        }

        function toggleAutoMode() {
            const newState = !autoModeState;
            const formData = new FormData();
            formData.append('action', 'auto');
            formData.append('state', newState ? '1' : '0');
            
            fetch('/gateControl', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(data => {
                console.log('Auto mode:', data);
                updateStatus();
            })
            .catch(error => console.error('Error:', error));
        }

        function restartSystem() {
            if (confirm('Are you sure you want to restart the system?')) {
                fetch('/restart', { method: 'POST' })
                .then(() => {
                    alert('System restarting...');
                    setTimeout(() => location.reload(), 5000);
                });
            }
        }

        document.getElementById('settingsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            fetch('/settings', { method: 'POST', body: formData })
            .then(response => response.text())
            .then(data => {
                alert('Settings saved: ' + data);
                loadConfig();
            })
            .catch(error => {
                alert('Error saving settings');
                console.error('Error:', error);
            });
        });

        document.getElementById('gateConfigForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            fetch('/settings', { method: 'POST', body: formData })
            .then(response => response.text())
            .then(data => {
                alert('Gate settings saved: ' + data);
                loadConfig();
            })
            .catch(error => {
                alert('Error saving gate settings');
                console.error('Error:', error);
            });
        });

        document.getElementById('restartBtn').addEventListener('click', restartSystem);

        // Initialize
        loadConfig();
        updateStatus();
        setInterval(updateStatus, 3000); // Update every 3 seconds
    </script>
</body>
</html>